# Task 2 - Amazon DynamoDB

_by Martijn Wiekens - 2024-06-11_

Task: Design a schema for a DynamoDB table that stores metadata about web pages crawled by our solution. The schema should support efficient querying for a given URL, date range, or a specific attribute (e.g., page title or word count). Provide examples of how to insert and query data using the AWS SDK for JavaScript

## Schema

Overview of the DynamoDB table schema:

### Columns

| Name            | Type        | Description                                       | Location                                     |
| --------------- | ----------- | ------------------------------------------------- | -------------------------------------------- |
| **id**          | String      | Unique identifier for each row in UUID form       | Generated by API                             |
| **url**         | String      | Full URL of the page that was crawled             | Page entered into system                     |
| **hostName**    | String      | Domain name that the page is part of              | Substring from `url`                         |
| **dateCrawled** | AWSDateTime | Date when the page was crawled from the web       | Datetime of page crawled by system           |
| **pageTitle**   | String      | Title of the page                                 | From the `title` tag in page HTML            |
| **wordCount**   | Number      | Amount of words on the page                       | Counted from the body of the page HTML       |
| **faviconUrl**  | String      | URL to the image that is the favicon              | From the `meta icon` tag in page HTML        |
| **language**    | String      | Language that the page reports it is in           | From the `html lang` tag in page HTML        |
| **description** | String      | Description of the page                           | From the `meta description` tag in page HTML |
| **keywords**    | String      | Keyworks of the page                              | From the `meta keywords` tag in page HTML    |
| **loadTime**    | Number      | Amount of time it took to finish loading the page | Calculated based on request time             |

### Keys

The keys that will be used in for this schema will be:

- Hash Key: `id` - Identifier of the row
- Range Key: `dateCrawled` - Make sure everything is ordered by the date

### Global Secondary Indexes

Index to improve query speed for pages in the table. Each entry is a different GSI. For each GSI we have a question we want to answer:

- What are all the pages for a giving domain? - `byHostName`
- Have we crawled a page on this url? - `byUrl`

#### byUrl

- Hash key: `url` - URL of the page
- Sort key: `dateCrawled` - Date it was crawled

#### byHostName

- Hash key: `hostName` - This is the name of the domain
- Sort key: `url` - Full URL of each page

## Examples

### Data row

An example of a row in the table as DynamoDB JSON:

```json
{
  "id": { "S": "22a3e087-cbc8-4f2e-981f-c6decff32858" },
  "url": { "S": "https://www.exads.com/products/white-label-ad-server" },
  "hostName": { "S": "www.exads.com" },
  "dateCrawled": { "S": "2024-06-11T12:12:13.000Z" },
  "pageTitle": {
    "S": "EXADS - Your Fully Customizable Ad Server | A Powerful and Fully Customizable Ad Server"
  },
  "wordCount": { "N": "2147" },
  "faviconUrl": { "S": "https://www.exads.com/favicon.ico" },
  "language": { "S": "en" },
  "description": {
    "S": "Take full control of the management, serving, and tracking of your advertising. Enjoy the simplicity of having all your essential functionalities under one roof."
  },
  "keywords": {
    "S": "customizable ad server, hosted ad server, need an ad server, self-service ad server, third party ad server, white label ad platform, white label ad server"
  },
  "loadTime": { "N": "2.23" }
}
```

### Query

Examples of how to query the data with AWS SDK for JavaScript.
For each example we need to setup DynamoDB first before we can request the data.

```javascript
// Import DynamoDB client
import { DynamoDBClient } from '@aws-sdk/client-dynamodb';
import {
  DynamoDBDocumentClient,
  GetCommand,
  ScanCommand,
  QueryCommand,
  PutCommand,
} from '@aws-sdk/lib-dynamodb';

// Create DynamoDB client
const client = new DynamoDBClient({});
const docClient = DynamoDBDocumentClient.from(client);
```

Here is an interface for the functions that return paginated result.

```typescript
interface IPaginatedPages {
  items: Array<IPage>;
  nextToken: string;
}
```

#### All pages

```typescript
async function ListPages(nextToken?: string): Promise<IPaginatedPages> {
  // Create a command to Query from the DynamoDB
  const command = new ScanCommand({
    TableName: 'WebPageMetaData',
    Limit: 20,
    ExclusiveStartKey: nextToken,
  });

  // Retrieve the response
  const response = await docClient.send(command);

  // Find the item
  if (result.Items) {
    return {
      items: result.Items,
      nextToken: result.LastEvaluatedKey,
    };
  }
  return { items: [], nextToken: null };
}
```

#### All pages for a day

```typescript
async function ListPagesByDate(
  dateStart: string,
  dateEnd: string,
  nextToken?: string,
): Promise<IPaginatedPages> {
  // Create a command to Query from the DynamoDB
  const command = new ScanCommand({
    TableName: 'WebPageMetaData',
    FilterExpression: '#DC > :sdc AND #DC < :dce',
    ExpressionAttributeNames: {
      '#DC': 'dateCrawled',
    },
    ExpressionAttributeValues: {
      ':sdc': dateStart,
      ':dce': dateEnd,
    },
    Limit: 20,
    ExclusiveStartKey: nextToken,
  });

  // Retrieve the response
  const response = await docClient.send(command);

  // Find the item
  if (result.Items) {
    return {
      items: result.Items,
      nextToken: result.LastEvaluatedKey,
    };
  }
  return { items: [], nextToken: null };
}
```

#### All pages for a domain

```typescript
async function ListPagesByHostname(
  hostName: string,
  nextToken?: string,
): Promise<IPaginatedPages> {
  // Create a command to Query from the DynamoDB
  const command = new QueryCommand({
    TableName: 'WebPageMetaData',
    IndexName: 'byHostName',
    KeyConditionExpression: '#HN = :hn',
    ExpressionAttributeNames: {
      '#HN': 'hostName',
    },
    ExpressionAttributeValues: {
      ':hn': hostName,
    },
    Limit: 20,
    ExclusiveStartKey: nextToken,
  });

  // Retrieve the response
  const response = await docClient.send(command);

  // Find the item
  if (result.Items) {
    return {
      items: result.Items,
      nextToken: result.LastEvaluatedKey,
    };
  }
  return { items: [], nextToken: null };
}
```

#### Specific page

```typescript
async function GetItem(pageId: string): Promise<IPage | null> {
  // Create a command to GetItem from the DynamoDB
  const command = new GetCommand({
    TableName: 'WebPageMetaData',
    Key: {
      id: pageId,
    },
  });

  // Retrieve the response
  const response = await docClient.send(command);

  // Find the item
  if (result.Item) {
    return result.Item;
  }
  return null;
}
```

### Insert

```typescript
async function PutItem(item: IPage): Promise<IPage> {
  // Check if we have an ID for the item
  if (!item.id) {
    // Generate a new UUID for the item
    item.id = crypto.randomUUID();
  }

  // Create a command to PutItem from the DynamoDB
  const command = new PutCommand({
    TableName: 'WebPageMetaData',
    Item: item,
  });

  // Retrieve the response
  const response = await docClient.send(command);

  // Return the item
  return item;
}
```
